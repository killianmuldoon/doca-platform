apiVersion: apps/v1
kind: DaemonSet
metadata:
  annotations:
    deprecated.daemonset.template.generation: "2"
    kubernetes.io/description: |
      This daemonset launches the ovn-kubernetes per node networking components.
    networkoperator.openshift.io/cluster-network-cidr: 10.128.0.0/14
    networkoperator.openshift.io/hybrid-overlay-status: disabled
    networkoperator.openshift.io/ip-family-mode: single-stack
    release.openshift.io/version: 4.14.9
  labels:
    networkoperator.openshift.io/generates-operator-status: stand-alone
  name: ovnkube-node
  namespace: openshift-ovn-kubernetes
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: ovnkube-node
  template:
    metadata:
      annotations:
        network.operator.openshift.io/ovnkube-script-lib-hash: 84bdf4517ed55f851a15b047c2e49a8b89bf13e0
        networkoperator.openshift.io/cluster-network-cidr: 10.128.0.0/14
        networkoperator.openshift.io/hybrid-overlay-status: disabled
        networkoperator.openshift.io/ip-family-mode: single-stack
        target.workload.openshift.io/management: '{"effect": "PreferredDuringScheduling"}'
      creationTimestamp: null
      labels:
        app: ovnkube-node
        component: network
        kubernetes.io/os: linux
        openshift.io/component: network
        ovn-db-pod: "true"
        type: infra
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: network.operator.openshift.io/dpu-host
                operator: DoesNotExist
              - key: network.operator.openshift.io/smart-nic
                operator: DoesNotExist
              - key: network.operator.openshift.io/dpu
                operator: DoesNotExist
      containers:
      - command:
        - /bin/bash
        - -c
        - |
          set -e
          . /ovnkube-lib/ovnkube-lib.sh || exit 1
          start-ovn-controller ${OVN_LOG_LEVEL}
        env:
        - name: OVN_LOG_LEVEL
          value: info
        - name: K8S_NODE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:4cfff02a08d37e4e962a50fac7958a508c94633275ed9cf1382189dad546e47c
        imagePullPolicy: IfNotPresent
        name: ovn-controller
        resources:
          requests:
            cpu: 10m
            memory: 300Mi
        securityContext:
          privileged: true
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /run/openvswitch
          name: run-openvswitch
        - mountPath: /run/ovn/
          name: run-ovn
        - mountPath: /etc/openvswitch
          name: etc-openvswitch
        - mountPath: /etc/ovn/
          name: etc-openvswitch
        - mountPath: /var/lib/openvswitch
          name: var-lib-openvswitch
        - mountPath: /env
          name: env-overrides
        - mountPath: /var/log/ovn/
          name: node-log
        - mountPath: /dev/log
          name: log-socket
      - command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          . /ovnkube-lib/ovnkube-lib.sh || exit 1
          start-audit-log-rotation
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:4cfff02a08d37e4e962a50fac7958a508c94633275ed9cf1382189dad546e47c
        imagePullPolicy: IfNotPresent
        name: ovn-acl-logging
        resources:
          requests:
            cpu: 10m
            memory: 20Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /var/log/ovn/
          name: node-log
        - mountPath: /run/ovn/
          name: run-ovn
      - command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          set -euo pipefail
          . /ovnkube-lib/ovnkube-lib.sh || exit 1
          start-rbac-proxy-node ovn-node-metrics 9103 29103 /etc/pki/tls/metrics-cert/tls.key /etc/pki/tls/metrics-cert/tls.crt
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:becb75a3f75a03809d5a9fca553dc4194ce22b787104301337af2c4d2fe5da8e
        imagePullPolicy: IfNotPresent
        name: kube-rbac-proxy-node
        ports:
        - containerPort: 9103
          hostPort: 9103
          name: https
          protocol: TCP
        resources:
          requests:
            cpu: 10m
            memory: 20Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /etc/pki/tls/metrics-cert
          name: ovn-node-metrics-cert
          readOnly: true
      - command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          set -euo pipefail
          . /ovnkube-lib/ovnkube-lib.sh || exit 1
          start-rbac-proxy-node ovn-metrics 9105 29105 /etc/pki/tls/metrics-cert/tls.key /etc/pki/tls/metrics-cert/tls.crt
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:becb75a3f75a03809d5a9fca553dc4194ce22b787104301337af2c4d2fe5da8e
        imagePullPolicy: IfNotPresent
        name: kube-rbac-proxy-ovn-metrics
        ports:
        - containerPort: 9105
          hostPort: 9105
          name: https
          protocol: TCP
        resources:
          requests:
            cpu: 10m
            memory: 20Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /etc/pki/tls/metrics-cert
          name: ovn-node-metrics-cert
          readOnly: true
      - command:
        - /bin/bash
        - -c
        - |
          set -xem
          if [[ -f /env/_master ]]; then
            set -o allexport
            source /env/_master
            set +o allexport
          fi
          . /ovnkube-lib/ovnkube-lib.sh || exit 1

          trap quit-ovn-northd TERM INT
          start-ovn-northd "${OVN_LOG_LEVEL}"
        env:
        - name: OVN_LOG_LEVEL
          value: info
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:4cfff02a08d37e4e962a50fac7958a508c94633275ed9cf1382189dad546e47c
        imagePullPolicy: IfNotPresent
        name: northd
        resources:
          requests:
            cpu: 10m
            memory: 70Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /etc/ovn
          name: etc-openvswitch
        - mountPath: /var/log/ovn
          name: node-log
        - mountPath: /run/ovn/
          name: run-ovn
        - mountPath: /env
          name: env-overrides
      - command:
        - /bin/bash
        - -c
        - |
          set -xem
          if [[ -f /env/_master ]]; then
            set -o allexport
            source /env/_master
            set +o allexport
          fi
          . /ovnkube-lib/ovnkube-lib.sh || exit 1

          trap quit-nbdb TERM INT
          start-nbdb ${OVN_LOG_LEVEL}
        env:
        - name: OVN_LOG_LEVEL
          value: info
        - name: K8S_NODE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:4cfff02a08d37e4e962a50fac7958a508c94633275ed9cf1382189dad546e47c
        imagePullPolicy: IfNotPresent
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/bash
              - -c
              - |
                set -x
                . /ovnkube-lib/ovnkube-lib.sh || exit 1
                nbdb-post-start 10000
        name: nbdb
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - |
              set -xeo pipefail
              . /ovnkube-lib/ovnkube-lib.sh || exit 1
              ovndb-readiness-probe "nb"
          failureThreshold: 3
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        resources:
          requests:
            cpu: 10m
            memory: 300Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /etc/ovn/
          name: etc-openvswitch
        - mountPath: /var/log/ovn
          name: node-log
        - mountPath: /run/ovn/
          name: run-ovn
        - mountPath: /env
          name: env-overrides
      - command:
        - /bin/bash
        - -c
        - |
          set -xem
          if [[ -f /env/_master ]]; then
            set -o allexport
            source /env/_master
            set +o allexport
          fi
          . /ovnkube-lib/ovnkube-lib.sh || exit 1

          trap quit-sbdb TERM INT
          start-sbdb ${OVN_LOG_LEVEL}
        env:
        - name: OVN_LOG_LEVEL
          value: info
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:4cfff02a08d37e4e962a50fac7958a508c94633275ed9cf1382189dad546e47c
        imagePullPolicy: IfNotPresent
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/bash
              - -c
              - |
                set -x
                . /ovnkube-lib/ovnkube-lib.sh || exit 1
                sbdb-post-start
        name: sbdb
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - |
              set -xeo pipefail
              . /ovnkube-lib/ovnkube-lib.sh || exit 1
              ovndb-readiness-probe "sb"
          failureThreshold: 3
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        resources:
          requests:
            cpu: 10m
            memory: 300Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /etc/ovn/
          name: etc-openvswitch
        - mountPath: /run/ovn/
          name: run-ovn
        - mountPath: /var/log/ovn
          name: node-log
        - mountPath: /env
          name: env-overrides
      - command:
        - /bin/bash
        - -c
        - |
          set -xe
          . /ovnkube-lib/ovnkube-lib.sh || exit 1
          start-ovnkube-node ${OVN_KUBE_LOG_LEVEL} 29103 29105
        env:
        - name: KUBERNETES_SERVICE_PORT
          value: "6443"
        - name: KUBERNETES_SERVICE_HOST
          value: api-int.vremmas-dev.nvidia.com
        - name: OVN_CONTROLLER_INACTIVITY_PROBE
          value: "180000"
        - name: OVN_KUBE_LOG_LEVEL
          value: "4"
        - name: K8S_NODE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:4cfff02a08d37e4e962a50fac7958a508c94633275ed9cf1382189dad546e47c
        imagePullPolicy: IfNotPresent
        lifecycle:
          preStop:
            exec:
              command:
              - rm
              - -f
              - /etc/cni/net.d/10-ovn-kubernetes.conf
        name: ovnkube-controller
        ports:
        - containerPort: 29105
          hostPort: 29105
          name: ovnmetrics-port
          protocol: TCP
        readinessProbe:
          exec:
            command:
            - test
            - -f
            - /etc/cni/net.d/10-ovn-kubernetes.conf
          failureThreshold: 3
          initialDelaySeconds: 5
          periodSeconds: 30
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          requests:
            cpu: 10m
            memory: 600Mi
        securityContext:
          privileged: true
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /ovnkube-lib
          name: ovnkube-script-lib
        - mountPath: /var/lib/kubelet
          name: host-kubelet
          readOnly: true
        - mountPath: /etc/systemd/system
          name: systemd-units
          readOnly: true
        - mountPath: /host
          mountPropagation: HostToContainer
          name: host-slash
          readOnly: true
        - mountPath: /run/ovn-kubernetes/
          name: host-run-ovn-kubernetes
        - mountPath: /run/netns
          mountPropagation: HostToContainer
          name: host-run-netns
          readOnly: true
        - mountPath: /cni-bin-dir
          name: host-cni-bin
        - mountPath: /etc/cni/net.d
          name: host-cni-netd
        - mountPath: /var/lib/cni/networks/ovn-k8s-cni-overlay
          name: host-var-lib-cni-networks-ovn-kubernetes
        - mountPath: /run/openvswitch
          name: run-openvswitch
        - mountPath: /var/log/ovnkube/
          name: etc-openvswitch
        - mountPath: /run/ovn/
          name: run-ovn
        - mountPath: /etc/openvswitch
          name: etc-openvswitch
        - mountPath: /etc/ovn/
          name: etc-openvswitch
        - mountPath: /var/lib/openvswitch
          name: var-lib-openvswitch
        - mountPath: /run/ovnkube-config/
          name: ovnkube-config
        - mountPath: /env
          name: env-overrides
      dnsPolicy: Default
      hostNetwork: true
      hostPID: true
      initContainers:
      - command:
        - /bin/bash
        - -c
        - |
          cat << EOF > /etc/ovn/kubeconfig
          apiVersion: v1
          clusters:
            - cluster:
                certificate-authority: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                server: https://api-int.vremmas-dev.nvidia.com:6443
              name: default-cluster
          contexts:
            - context:
                cluster: default-cluster
                namespace: default
                user: default-auth
              name: default-context
          current-context: default-context
          kind: Config
          preferences: {}
          users:
            - name: default-auth
              user:
                client-certificate: /etc/ovn/ovnkube-node-certs/ovnkube-client-current.pem
                client-key: /etc/ovn/ovnkube-node-certs/ovnkube-client-current.pem
          EOF
        image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:4cfff02a08d37e4e962a50fac7958a508c94633275ed9cf1382189dad546e47c
        imagePullPolicy: IfNotPresent
        name: kubecfg-setup
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /etc/ovn/
          name: etc-openvswitch
      nodeSelector:
        beta.kubernetes.io/os: linux
      priorityClassName: system-node-critical
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: ovn-kubernetes-node
      serviceAccountName: ovn-kubernetes-node
      terminationGracePeriodSeconds: 30
      tolerations:
      - operator: Exists
      volumes:
      - hostPath:
          path: /var/lib/kubelet
          type: ""
        name: host-kubelet
      - hostPath:
          path: /etc/systemd/system
          type: ""
        name: systemd-units
      - hostPath:
          path: /
          type: ""
        name: host-slash
      - hostPath:
          path: /run/netns
          type: ""
        name: host-run-netns
      - hostPath:
          path: /var/lib/openvswitch/data
          type: ""
        name: var-lib-openvswitch
      - hostPath:
          path: /var/lib/ovn-ic/etc
          type: ""
        name: etc-openvswitch
      - hostPath:
          path: /var/run/openvswitch
          type: ""
        name: run-openvswitch
      - hostPath:
          path: /var/run/ovn-ic
          type: ""
        name: run-ovn
      - hostPath:
          path: /var/log/ovn
          type: ""
        name: node-log
      - hostPath:
          path: /dev/log
          type: ""
        name: log-socket
      - hostPath:
          path: /run/ovn-kubernetes
          type: ""
        name: host-run-ovn-kubernetes
      - hostPath:
          path: /var/lib/cni/bin
          type: ""
        name: host-cni-bin
      - hostPath:
          path: /var/run/multus/cni/net.d
          type: ""
        name: host-cni-netd
      - hostPath:
          path: /var/lib/cni/networks/ovn-k8s-cni-overlay
          type: ""
        name: host-var-lib-cni-networks-ovn-kubernetes
      - configMap:
          defaultMode: 420
          name: ovnkube-config
        name: ovnkube-config
      - configMap:
          defaultMode: 420
          name: env-overrides
          optional: true
        name: env-overrides
      - name: ovn-node-metrics-cert
        secret:
          defaultMode: 420
          optional: true
          secretName: ovn-node-metrics-cert
      - configMap:
          defaultMode: 484
          name: ovnkube-script-lib
        name: ovnkube-script-lib
  updateStrategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 10%
    type: RollingUpdate
status:
  currentNumberScheduled: 1
  desiredNumberScheduled: 1
  numberAvailable: 1
  numberMisscheduled: 0
  numberReady: 1
  observedGeneration: 2
  updatedNumberScheduled: 1
