apiVersion: svc.dpf.nvidia.com/v1alpha1
kind: DPUService
metadata:
  name: hbn-dpuservice
  namespace: hbn
spec:
  source:
    repoURL:  nvidia.com/dpf
    version: v0.1.0
    chart: hbn
  serviceID: hbn
  serviceDaemonSet:
    nodeSelector:
      nodeSelectorTerms:
      - matchExpressions:
          - key: dpu
            operator: In
            values:
              - dpu
    resources:
      cpu: 1
      nvidia.com/dpu: 1
    updateStrategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 2
    labels:
      dpuservice.dpf.nvidia.com/name: hbn
    annotations:
      dpuservice.dpf.nvidia.com/name: hbn
  values:
    hbnNodesConf:
      hbnNodesConfigJson: |-
        {
          "host1": {
            "lo_ip": "10.10.10.1/32",
            "lo_ipv6": "2010:10:10::1/128",
            "vlan_ip": "30.30.30.1/24",
            "vlan_ipv6": "2030:30:30::1/64",
            "vlan_id": "101",
            "bgp_autonomous_system": "65501",
            "bgp_router_id": "10.10.10.1"
          },
          "clx-host-068-dpu.maas": {
            "lo_ip": "10.10.10.2/32",
            "lo_ipv6": "2010:10:10::2/128",
            "vlan_ip": "30.30.30.2/24",
            "vlan_ipv6": "2030:30:30::2/64",
            "vlan_id": "102",
            "bgp_autonomous_system": "65502",
            "bgp_router_id": "10.10.10.2"
          },
          "host3": {
            "lo_ip": "10.10.10.3/32",
            "lo_ipv6": "2010:10:10::3/128",
            "vlan_ip": "30.30.30.3/24",
            "vlan_ipv6": "2030:30:30::3/64",
            "vlan_id": "103",
            "bgp_autonomous_system": "65503",
            "bgp_router_id": "10.10.10.3"
          }
        }

    # 8) Startup template for HBN pod. Can be set in DPUService `.spec.values.j2StartupTemplate.startupYamlJ2`
    j2StartupTemplate:
      startupYamlJ2: |-
        - header:
            model: BLUEFIELD
            nvue-api-version: nvue_v1
            rev-id: 1.0
            version: HBN 2.1.0
        - set:
            bridge:
              domain:
                br_default:
                  vlan:
                    '{{ config.vlan_id }}': {}
            interface:
              lo:
                ip:
                  address:
                    {{ config.lo_ip }}: {}
                    {{ config.lo_ipv6 }}: {}
                type: loopback
              p0_sf:
                type: swp
              vlan{{ config.vlan_id }}:
                base-interface: br_default
                ip:
                  address:
                    {{ config.vlan_ip }}: {}
                    {{ config.vlan_ipv6 }}: {}
                type: svi
                vlan: {{ config.vlan_id }}
            router:
              bgp:
                enable: on
            vrf:
              default:
                router:
                  bgp:
                    address-family:
                      ipv4-unicast:
                        enable: on
                        redistribute:
                          connected:
                            enable: on
                      ipv6-unicast:
                        enable: on
                        redistribute:
                          connected:
                            enable: on
                    autonomous-system: {{ config.bgp_autonomous_system }}
                    enable: on
                    neighbor:
                      p0_sf:
                        address-family:
                          ipv4-unicast:
                            enable: on
                          ipv6-unicast:
                            enable: on
                        remote-as: external
                        type: unnumbered
                    path-selection:
                      multipath:
                        aspath-ignore: on
                    router-id: {{ config.bgp_router_id }}

