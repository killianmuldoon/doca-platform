apiVersion: provisioning.dpf.nvidia.com/v1alpha1
kind: DPUFlavor
metadata:
  name: hbn-ovn
  namespace: dpf-provisioning
spec:
  grub:
    kernelParameters:
      - console=hvc0
      - console=ttyAMA0
      - earlycon=pl011,0x13010000
      - fixrttc
      - net.ifnames=0
      - biosdevname=0
      - iommu.passthrough=1
      - cgroup_no_v1=net_prio,net_cls
      - hugepagesz=2048kB
      - hugepages=3072
  nvconfig:
    - device: "*"
      parameters: 
        - PF_BAR2_ENABLE=0
        - PER_PF_NUM_SF=1
        - PF_TOTAL_SF=20
        - PF_SF_BAR_SIZE=10
        - NUM_PF_MSIX_VALID=0
        - PF_NUM_PF_MSIX_VALID=1
        - PF_NUM_PF_MSIX=228
        - INTERNAL_CPU_MODEL=1
        - INTERNAL_CPU_OFFLOAD_ENGINE=0
        - SRIOV_EN=1
        - NUM_OF_VFS=46
        - LAG_RESOURCE_ALLOCATION=1
  ovs:
    rawConfigScript: |
      ovs-vsctl set Open_vSwitch . other_config:doca-init=true -- \
      set Open_vSwitch . other_config:dpdk-extra="-a 0000:00:00.0" -- \
      set Open_vSwitch . other_config:hw-offload-ct-size=64000 -- \
      set Open_vSwitch . other_config:dpdk-max-memzones="50000" -- \
      set Open_vSwitch . other_config:hw-offload="true" -- \
      set Open_vSwitch . other_config:pmd-quiet-idle=true -- \
      set Open_vSwitch . other_config:max-idle=20000 -- \
      set Open_vSwitch . other_config:max-revalidator=5000 -- \
      --if-exists del-br ovsbr1 -- \
      --if-exists del-br ovsbr2 -- \
      --may-exist add-br br-sfc -- \
      set bridge br-sfc datapath_type=netdev -- \
      set bridge br-sfc fail_mode=secure -- \
      --may-exist add-port br-sfc p0 -- \
      set Interface p0 type=dpdk

      ovs-vsctl --may-exist add-br br-ovn-k8s-ch -- \
      --may-exist add-br br-kubelet-ch -- \
      set bridge br-ovn-k8s-ch datapath_type=netdev -- \
      set bridge br-kubelet-ch datapath_type=netdev

      ovs-vsctl add-port br-kubelet-ch pf0vf1 || true
      ovs-vsctl add-port br-ovn-k8s-ch pf0vf2 || true
      ovs-vsctl --may-exist add-port br-kubelet-ch en3f0pf0sf1000 || true
      ovs-vsctl --may-exist add-port br-ovn-k8s-ch en3f0pf0sf1001 || true

      ovs-vsctl set Interface pf0vf1 type=dpdk -- \
      set Interface pf0vf2 type=dpdk -- \
      set Interface en3f0pf0sf1000 type=dpdk -- \
      set Interface en3f0pf0sf1001 type=dpdk
      systemctl restart openvswitch-switch
  bfcfgParameters:
    - UPDATE_ATF_UEFI=yes
    - UPDATE_DPU_OS=yes
    - WITH_NIC_FW_UPDATE=yes

  configFiles:
  - path: /etc/mellanox/mlnx-bf.conf
    operation: override
    raw: |
        ALLOW_SHARED_RQ="no"
        IPSEC_FULL_OFFLOAD="no"
        ENABLE_ESWITCH_MULTIPORT="yes"
    permissions: "0644"
  - path: /etc/mellanox/mlnx-ovs.conf
    operation: override
    raw: |
        CREATE_OVS_BRIDGES="no"
    permissions: "0644"
  - path: /etc/mellanox/mlnx-sf.conf 
    operation: override
    raw: ""
    permissions: "0644"