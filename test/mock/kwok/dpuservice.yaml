apiVersion: svc.dpu.nvidia.com/v1alpha1
kind: DPUService
metadata:
  name: kwok-dpu
  namespace: dpf-operator-system
spec:
  deployInCluster: true
  helmChart:
    values:
      env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: KUBERNETES_SERVICE_HOST
          valueFrom:
            secretKeyRef:
              name: kwok-credentials
              key: KUBERNETES_SERVICE_HOST
        - name: KUBERNETES_SERVICE_PORT
          valueFrom:
            secretKeyRef:
              name: kwok-credentials
              key: KUBERNETES_SERVICE_PORT
      nodeSelector:
        node-role.kubernetes.io/control-plane: ""
      tolerations:
        - operator: Exists
          effect: NoSchedule
          key: node-role.kubernetes.io/control-plane
        - operator: Exists
          effect: NoSchedule
          key: node-role.kubernetes.io/master
      volumeMounts:
        - name: tokenfile
          mountPath: "/var/run/secrets/kubernetes.io/serviceaccount"
          readOnly: true
    source:
      repoURL: oci://gitlab-master.nvidia.com:5005/doca-platform-foundation/doca-platform-foundation/e2e
      chart: kwok
      version: v0.1.0-c0d7e2e5-test
---
apiVersion: svc.dpu.nvidia.com/v1alpha1
kind: DPUService
metadata:
  name: kwok-dpu-crds
  namespace: dpf-operator-system
spec:
  helmChart:
    values:
      enableDeployment: false
    source:
      repoURL: oci://gitlab-master.nvidia.com:5005/doca-platform-foundation/doca-platform-foundation/e2e
      chart: kwok
      version: v0.1.0-c0d7e2e5-test
---
apiVersion: svc.dpu.nvidia.com/v1alpha1
kind: DPUService
metadata:
  name: kwok-stage-fast
  namespace: dpf-operator-system
spec:
  helmChart:
    values:
      enableDeployment: false
    source:
      repoURL: https://kwok.sigs.k8s.io/charts
      chart: stage-fast
      version: v0.1.1
---
apiVersion: svc.dpu.nvidia.com/v1alpha1
kind: DPUServiceCredentialRequest
metadata:
  name: kwok-credentials
  namespace: dpf-operator-system
spec:
  duration: 24h
  serviceAccount:
    name: kwok-controller
    namespace: dpf-operator-system
  targetCluster:
    name: dpu-cluster-1
    namespace: dpf-operator-system
  type: tokenFile
  secret:
    name: kwok-credentials
    namespace: dpf-operator-system
