apiVersion: v1
kind: ReplicationController
metadata:
  name: dpu-node
  namespace: dpu-01
  labels:
    name: dpu-node
spec:
  replicas: 3
  selector:
    name: dpu-node
  template:
    metadata:
      labels:
        name: dpu-node
    spec:
      initContainers:
        - name: init-inotify-limit
          image: busybox:1.32
          command: ['sysctl', '-w', 'fs.inotify.max_user_instances=1000']
          securityContext:
            privileged: true
      volumes:
        - name: kubeconfig-volume
          secret:
            secretName: kubeconfig
        - name: kernelmonitorconfig-volume
          configMap:
            name: node-configmap
        - name: logs-volume
          hostPath:
            path: /var/log
        - name: containerd
          hostPath:
            path: /run/containerd
        - name: no-serviceaccount-access-to-real-master
          emptyDir: {}
      containers:
        - name: hollow-kubelet
          image: harbor.mellanox.com/cloud-orchestration-dev/killian/kubemark-arm64:v1.28.0
          ports:
            - containerPort: 4194
            - containerPort: 10250
            - containerPort: 10255
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: [
            "/go-runner",
            "-log-file=/var/log/kubelet-$(NODE_NAME).log",
            "/kubemark",
            "--morph=kubelet",
            "--name=$(NODE_NAME)",
            "--v=5",
            "--kubeconfig=/kubeconfig/kubelet.kubeconfig",
            "--containerd=/run/cri-docker.sock",
          ]
          volumeMounts:
            - name: kubeconfig-volume
              mountPath: /kubeconfig
              readOnly: true
            - name: logs-volume
              mountPath: /var/log
            - name: containerd
              mountPath: /run/containerd
          securityContext:
            privileged: true
        - name: hollow-proxy
          image: harbor.mellanox.com/cloud-orchestration-dev/killian/kubemark-arm64:v1.28.0
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: [
            "/go-runner",
            "-log-file=/var/log/kubeproxy-$(NODE_NAME).log",
            "/kubemark",
            "--morph=proxy",
            "--name=$(NODE_NAME)",
            "--kubeconfig=/kubeconfig/kubeproxy.kubeconfig",
          ]
          volumeMounts:
            - name: kubeconfig-volume
              mountPath: /kubeconfig
              readOnly: true
            - name: logs-volume
              mountPath: /var/log
      tolerations:
        - key: "node.kubernetes.io/unreachable"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 900
